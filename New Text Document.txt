# --- LOADING BAR FOR STEP 5 (THE BRAIN) ---
    st.divider()
    
    # 1. First Loader: The Math & Logic (Calculations happen here)
    with st.status("ğŸ§  Processing Deep GEO Metrics (This takes ~20s)...", expanded=True) as status:
        st.write("ğŸ›¡ï¸ Analyzing Tone & Trust Score...")
        trust_score = calculate_trust_score(user_data['text'], model)
        
        st.write("ğŸ“Š Calculating Fact Density (AI vs User)...")
        user_density = calculate_fact_density_smart(user_data['text'], model)
        ai_density = calculate_fact_density_smart(ai_text, model)
        
        st.write("ğŸ“– Measuring Readability Complexity...")
        user_readability = textstat.flesch_reading_ease(user_data['text'])
        ai_readability = textstat.flesch_reading_ease(ai_text)
        
        status.update(label="âœ… Deep Analysis Complete", state="complete", expanded=False)

    # --- STEP 5: GEO ANALYSIS LAYER (THE VISUALS) ---
    st.subheader("ğŸ§  Step 5: The GEO Analysis Layer")
    
    # 2. Second Loader: The Visuals (Charts render here)
    with st.spinner("ğŸ¨ Generating visual demonstrations & plotting graphs..."):
        time.sleep(1.5) # Aesthetic pause so the user sees the "Generating" text
        
        # Competitor logic
        if comp_data:
            comp_density = calculate_fact_density_smart(comp_data['text'], model)
            st.info(f"âš”ï¸ **Competitor Intel:** They have **{comp_data['word_count']} words** and **{comp_data['lists']} lists** (Density: {comp_density}%).")
        
        c1, c2, c3 = st.columns(3)
        
        # MODULE A: TRUST SCORE (Added key="trust_chart" to fix crash)
        with c1:
            st.markdown("#### ğŸ›¡ï¸ Trust Score")
            fig = go.Figure(go.Indicator(
                mode = "gauge+number", value = trust_score,
                domain = {'x': [0, 1], 'y': [0, 1]},
                title = {'text': "Hype Check"},
                gauge = {'axis': {'range': [0, 100]}, 'bar': {'color': "#00D4FF"},
                         'steps': [{'range': [0, 40], 'color': "#FF4B4B"}, {'range': [80, 100], 'color': "#00CC96"}]}
            ))
            fig.update_layout(height=250, margin=dict(l=10,r=10,t=30,b=10), paper_bgcolor="#0E1117", font={'color': "white"})
            st.plotly_chart(fig, use_container_width=True, key="trust_chart")

        # MODULE B: FACT DENSITY (Added key="density_chart" to fix crash)
        with c2:
            st.markdown("#### ğŸ“Š Fact Density")
            sources = ['AI Requirement', 'Your Content']
            densities = [ai_density, user_density]
            colors = ['#00CC96', '#FF4B4B' if user_density < ai_density else '#00D4FF']
            
            if comp_data:
                sources.append("Competitor")
                densities.append(comp_density)
                colors.append('#FFA500') 

            fig2 = go.Figure(data=[go.Bar(x=sources, y=densities, marker_color=colors)])
            fig2.update_layout(title="Hard Entities Ratio", height=250, paper_bgcolor="#0E1117", plot_bgcolor="#0E1117", font={'color': "white"})
            st.plotly_chart(fig2, use_container_width=True, key="density_chart")

        # MODULE C: READABILITY
        with c3:
            st.markdown("#### ğŸ“– Readability Match")
            diff = abs(user_readability - ai_readability)
            st.metric("Reading Ease Score", f"{user_readability:.1f}", delta=f"Diff: {diff:.1f}")
            if diff > 15: st.warning("âš ï¸ Style Mismatch.")
            else: st.success("âœ… Style Aligned.")